
name: Release NumRs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Publish Core & C-Crate to Crates.io
  # 1. Publish Core
  publish-core:
    name: Publish Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Publish numrs-core
        working-directory: ./numrs-core
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true

  # 2. Publish C-Crate
  publish-c:
    name: Publish C-Binding
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish numrs-c
        working-directory: ./bindings/numrs-c
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true

  # 3. Publish WASM (Parallel)
  publish-wasm:
    name: Publish WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust (WASM)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Build WASM
        working-directory: ./bindings/numrs-wasm
        run: |
          npm install
          npm run build:all

      - name: Publish WASM
        working-directory: ./bindings/numrs-wasm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

  # 4. Publish Node.js (Parallel)
  publish-node:
    name: Publish Node.js
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Build Node Binding
        working-directory: ./bindings/numrs-js
        run: |
          npm install
          npm run build

      - name: Publish Node Binding
        working-directory: ./bindings/numrs-js
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

  # 5. Build & Publish Python Wheels (Matrix)
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]

    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.16.5
        env:
          # Important: Tell cibuildwheel to build numrs-c first
          CIBW_ARCHS: "auto64"
          CIBW_BEFORE_ALL_LINUX: "if [ -f /etc/alpine-release ]; then apk add --no-cache curl build-base; else yum install -y curl || true; fi && curl https://sh.rustup.rs -sSf | sh -s -- -y && export PATH=$HOME/.cargo/bin:$PATH && cargo build --release --manifest-path bindings/numrs-c/Cargo.toml"
          CIBW_BEFORE_ALL_MACOS: "cd bindings/numrs-c && cargo build --release"
          CIBW_BEFORE_ALL_WINDOWS: "cd bindings/numrs-c && cargo build --release"
          
          # Repair wheels: auditwheel (Linux) and delocate (Mac) automatically bundle the .so/.dylib
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/project/bindings/numrs-c/target/release && auditwheel repair -w {dest_dir} {wheel}"
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: "delocate-listdeps {wheel} && delocate-wheel -w {dest_dir} -v {wheel}"
          
          # Point setup.py to the built library
          # Note: We need a custom env var or move file logic in setup.py to find the lib
          # For now, simplistic approach: copy lib to package dir in BEFORE_BUILD
          CIBW_BEFORE_BUILD: "cp bindings/numrs-c/target/release/libnumrs_c* bindings/numrs-py/numrs/ || echo 'Windows DLL copy logic here'"

        with:
          package-dir: ./bindings/numrs-py
          output-dir: wheelhouse

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  publish-pypi:
    name: Publish to PyPI
    needs: build-wheels
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: cibw-wheels-*
          path: dist
          merge-multiple: true

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages_dir: dist/

